var game={nsData:Girls,nsSelectedData:[],nsWinNum:0,giftsData:Gifts,giftsSelectedData:[],giftsNum:null,resultsData:Results,curGiftIds:[],gameOn:false,nsBonuIds:[],bonuOfKeep:0,lastingHits:0,spliceArrGroup:function(targetArr,amount){var i,len=targetArr.length,rand,newarr=new Array();for(i=amount;i>0;i--){rand=Math.floor(Math.random()*len);newarr.push(targetArr.splice(rand,1)[0]);len=targetArr.length;}
if(amount==1){return newarr[0];}else{return newarr;}},selectNsData:function(num){var _this=this,arr=this.spliceArrGroup(this.nsData,num);$.each(arr,function(index,val){if(val.bonus){_this.nsBonuIds.push(val.id);}});this.nsSelectedData=arr;},selectGiftsData:function(){var _this=this,nsSelectedData=this.nsSelectedData,giftsData=this.giftsData,selectedGiftData=[];$.each(nsSelectedData,function(index,value){var id=value.id,eqArr=[],temp,rand;$.each(giftsData,function(eq,val){var ids=val.ids;if($.inArray(id,ids)>-1){eqArr.push(eq);};});if(eqArr.length==1){temp=_this.giftsData.splice(eqArr[0],1)[0];}else if(eqArr.length>1){rand=Math.floor(Math.random()*eqArr.length);temp=_this.giftsData.splice(eqArr[rand],1)[0];}else{temp=_this.giftsData.pop();};selectedGiftData.push(temp);giftsData=_this.giftsData;});this.giftsSelectedData=selectedGiftData;this.giftsNum=selectedGiftData.length;},initNsBox:function(){var data=this.nsSelectedData,len=this.nsSelectedData.length;for(var i=0;i<len;i++){$('#g-card'+i).find('.g-card-inner').css('background-position','-'+50*data[i].id+'px top');$('#g-card'+i).attr('data-id',data[i].id).find('.hobbys').addClass('show').find('span').html(data[i].hobby);$('#g-card'+i).find('.ns-photo').html(data[i].name);};this.displayGiftsNum(this.giftsNum);this.displayNsNum(this.nsWinNum);},displayHobbys:function(flag){switch(flag){case"show":$('.hobbys').addClass('show');break;case"hide":$('.hobbys').removeClass('show').removeClass('keep');break;case"keep":var arr=[0,1,2,3,4,5,6,7];arr=this.spliceArrGroup(arr,4);$.each(arr,function(index,val){$('#g-card'+val+' .hobbys').addClass('keep');});$('.hobbys').not(".keep").removeClass('show');break;}},displayGiftsNum:function(num){$('#gift-num-display span').html(num);},updateGiftsNum:function(delta){var delta=delta||0;this.giftsNum+=delta;this.displayGiftsNum(this.giftsNum);},displayNsNum:function(num){$('#ns-num-display span').html(num);},updateNsNum:function(delta){var delta=delta||0;this.nsWinNum+=delta;this.displayNsNum(this.nsWinNum);},displayGift:function(){var gift=this.spliceArrGroup(this.giftsSelectedData,1),giftName=gift.name,bgLeft;this.curShowGift=gift;this.updateGiftsNum(-1);this.curGiftIds=gift.ids;bgLeft=-50*(gift.position-1);$('#gift-card .gift-photo').css('background-position',bgLeft+'px top');$('#gift-card .desc span').html(giftName);this.openGift();this.delayExec(0,function(){this.showGiftName();});},selectNs:function(){var _this=this,nsOption=$('.ns-girl-card'),id;nsOption.on('mousedown',function(e){e.preventDefault();id=parseInt($(this).attr('data-id'));}).on('mouseup',function(e){e.preventDefault();if($.inArray(id,_this.curGiftIds)>-1){_this.lastingHits+=1;_this.correct($(this),id);_this.addNewNs($(this));}else{if(_this.giftsNum==0){_this.gameOver();return;};_this.lastingHits=0;_this.wrong($(this));_this.addNewNs(_this.replaceDom,true);}
nsOption.off('mouseenter mouseup');_this.newRound();});},newRound:function(){this.delayExec(1,function(){this.showGiftName('hide');this.displayHobbys('show');this.openGift(true);});this.count(5);this.delayExec(0,function(){if(!this.bonuOfKeep){this.displayHobbys('hide');}else{this.displayHobbys('keep');this.bonuOfKeep=0;}});this.delayExec(0,function(){$('#gift-card .count').hide();this.displayGift();this.selectNs();});},correct:function(dom,id){var _this=this;dom.find('.show-result').removeClass('break').addClass('right show');$.each(_this.nsSelectedData,function(index,value){if(value.id==id){var ns=_this.nsSelectedData.splice(index,1);}});this.delayExec(2,function(){this.updateNsNum(1);});if(this.lastingHits==3){this.lastingHits=0;this.bonus('tips');}
var bonu_g_index=$.inArray(id,this.nsBonuIds);if(bonu_g_index>-1){this.curGiftIds.splice(bonu_g_index,1);this.nsBonuIds.splice(bonu_g_index,1);this.bonus('gift');}
this.delayExec(0,function(){dom.find('.show-result').removeClass('show');});if(this.nsData.length==0){}},bonus:function(type){var _this=this;switch(type){case"tips":var awords='不错哦！居然三连中！！奖励保留提示一轮~';this.bonuOfKeep=1;showBonus('tips',awords,2);break;case"gift":var awords='厉害哦！女神夸你聪明又有心！！回赠礼物一枚~';showBonus('gift',awords,4);break;}
function showBonus(type,awords,time){var gift_card_top=$('#gift-card').offset().top+9;$('#bonu').css({top:gift_card_top}).show().find('span').html(awords);_this.delayExec(time,function(){$('#bonu').hide();});if(type=='gift'){showGiftAdd(gift_card_top);}}
function showGiftAdd(bonuTop){var targetPos=$('#gift-num-display span').offset();targetPos.top=targetPos.top-bonuTop;$('#gift-bonus').addClass('animate').css({top:targetPos.top,left:targetPos.left,opacity:1});setTimeout(function(){$('#gift-bonus').removeClass('animate').css({opacity:0,top:0,left:'50%'});_this.giftsNum+=1;_this.displayGiftsNum(_this.giftsNum);},1000);}},wrong:function(dom){var _this=this,id=this.curGiftIds.pop(),rightCard=$('.ns-girl-card').filter('[data-id="'+id+'"]'),curGift=this.curShowGift;this.replaceDom=rightCard;$.each(_this.nsSelectedData,function(index,value){if(value.id==id){var ns=_this.nsSelectedData.splice(index,1)[0];_this.nsData.push(ns);}});this.giftsData.push(curGift);dom.find('.show-result').removeClass('right break').addClass('show');rightCard.find('.show-result').addClass('show break');this.delayExec(3,function(){dom.find('.show-result').removeClass('show');rightCard.find('.show-result').removeClass('show');});},gameOver:function(){var girls_num=this.nsWinNum,resultData=this.resultsData;$('#show-results .hearts span').html(girls_num);$.each(resultData,function(key,val){if(typeof(val['scores'])=="number"){if(key==girls_num){$('#show-results .conclusion').html(val['remark']);return false;};}else{if(girls_num>=val['scores'][0]&&girls_num<=val['scores'][1]){$('#show-results .conclusion').html(val['remark']);return false;};}
return;});$('#show-results').show();},addNewNs:function(dom,dataOnly){if(this.nsData.length==0){this.addNewGift();return;};var newNs=this.spliceArrGroup(this.nsData,1),id=newNs.id;if(newNs.bonus){this.nsBonuIds.push(id);};this.nsSelectedData.push(newNs);this.delayExec(0,function(){dom.find('.g-card-inner').css('background-position','-'+50*id+'px top');dom.attr('data-id',newNs.id);dom.find('.hobbys span').html(newNs.hobby);dom.find('.ns-photo').html(newNs.name);});if(!dataOnly){this.addNewGift(id);}else{this.addNewGift(id,true);}},addNewGift:function(id,giftNumInc){var _this=this,giftsData=this.giftsData,eqArr=[],temp;if(!id){temp=_this.spliceArrGroup(_this.giftsData,1);}else{$.each(giftsData,function(eq,val){var ids=val.ids;if($.inArray(id,ids)>-1){eqArr.push(eq);};});if(eqArr.length==1){temp=_this.giftsData.splice(eqArr[0],1)[0];}else if(eqArr.length>1){temp=_this.spliceArrGroup(_this.giftsData,1);}else{temp=_this.giftsData.pop();};};this.giftsSelectedData.push(temp);if(!giftNumInc){this.updateGiftsNum(1);}},count:function(senconds){this.delayExec(senconds,function(count){if(count>0&&count<=senconds){$('#gift-card .count').show().html(count);}else if(count==0){$('#gift-card .count').html('go');}},'each');},showGiftName:function(flag){if(flag=='hide'){$('#gift-card .desc').find('span').html("");$('#gift-card .desc').removeClass('show');return;}
$('#gift-card .desc').addClass('show');},openGift:function(reverse){$('#gift-canvas').removeClass('bg');var canvas=$('#gift-canvas')[0],ctx=canvas.getContext('2d');function drawTrig(x){ctx.clearRect(0,0,100,100);var grd=ctx.createLinearGradient(x,x,x/2,x/2);grd.addColorStop(0,"#92B6D5");grd.addColorStop(.8,"#F1F8FC");grd.addColorStop(1,"#41729F");ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(51,0);ctx.lineTo(51,51);ctx.lineTo(0,51);ctx.lineTo(0,x);ctx.closePath();ctx.fillStyle='#749bbe';ctx.fill();var grd_shadow=ctx.createLinearGradient(x,x,x/2,x/2);grd_shadow.addColorStop(.4,'rgba(23, 71, 116, 0)');grd_shadow.addColorStop(1,'rgba(23, 71, 116, .6)');ctx.beginPath();ctx.moveTo(0,2*x);ctx.lineTo(2*x,0);ctx.lineTo(x,0);ctx.lineTo(0,x);ctx.closePath();ctx.fillStyle=grd_shadow;ctx.fill();ctx.beginPath();ctx.moveTo(0,x);ctx.lineTo(x,0);ctx.lineTo(x,x);ctx.closePath();ctx.fillStyle=grd;ctx.fill();};function trigMove(startPos,rev){var start=startPos||0;var trigAnimate=function(){if(rev){if(start<0)
return;start-=4;}else{if(start>100)
return;start+=4;}
drawTrig(start);setTimeout(arguments.callee,40);}
();};if(reverse){trigMove(100,true);}else{trigMove();}},delayExec:function(num,callback,exeTime){var _this=this,exeTimer;if(exeTime=='each'){exeTimer=true;}else{exeTimer=false;};if(!this.queues){this.queues=[];};this.queues.push([num,callback,exeTimer]);var index_id=this.queues.length;var countTime=num,callback=callback;var count=function(){if(index_id!=1)
return;if(countTime>=0){if(exeTimer){callback.call(_this,countTime);}else{if(countTime==0){callback.call(_this,countTime);}}
countTime-=1;if(countTime==0){setTimeout(arguments.callee,0);}else{setTimeout(arguments.callee,1000);}}else{_this.queues.shift();if(_this.queues.length<=0)
return;countTime=_this.queues[0][0];callback=_this.queues[0][1];exeTimer=_this.queues[0][2];arguments.callee();}};count.apply(this);return this;},beginTips:function(){var html='<div class="warm-tips"><div class="warm-tips-inner"><p>游戏马上开始了，准备好了吗？</p><p class="warm-tips-count"></p></div></div>';$('body').append(html);this.delayExec(5,function(count){if(count==0)count='GAME START!';$('.warm-tips-count').html(count);},'each').delayExec(2,function(){$('.warm-tips').remove();});},start:function(){this.selectNsData(8);this.selectGiftsData();this.initNsBox();this.beginTips();this.count(10);this.delayExec(0,function(){$('.hobbys').removeClass('show');}).delayExec(0,function(){$('#gift-card .count').hide();this.displayGift();this.selectNs();});}};